{% extends 'base.html' %}
{% load static %}

{% block title %}Rezervace Hřiště{% endblock %}

{% block content %}
<style>
  .reservation-slot {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .reservation-slot.reserved {
    background-color: #dc3545; /* Red for reserved */
    color: white;
    cursor: not-allowed;
  }
  
  .reservation-slot.free {
    background-color: #28a745; /* Green for free */
    color: white;
  }
  
  .reservation-slot.selected {
    background-color: #ffc107; /* Yellow for selected */
    color: black;
  }
  
  .reservation-slot.free:hover:not(.selected) {
    background-color: #218838; /* Darker green on hover */
  }
  
  #submit-reservations:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<div class="container my-5">
    <!-- Hlavička stránky -->
    <div class="row">
      <div class="col-sm-3"></div>
      <div class="col-sm-6">
        <div class="card text-center" style="padding: 15px; border-width: 4px; 
             border-radius: 10px; background: rgba(255, 255, 255, 0.5)">
          <h2>Rezervace</h2>
          <p>Zde naleznete přehled rezervací hřišť na vybraný den.</p>
        </div>
      </div>
      <div class="col-sm-3"></div>
    </div>

    <!-- Formulář pro filtrování (datum + typ hřiště) -->
    <div class="row mt-4 mb-4">
      <div class="col-sm-12">
        <div class="card" style="padding: 20px; background: rgba(255, 255, 255, 0.5);">
          <form method="GET" class="row g-3">
            <div class="col-auto">
              <label for="datum" class="form-label">Datum</label>
              <input type="date" name="datum" id="datum" value="{{ vybrane_datum|date:'Y-m-d' }}" class="form-control" />
            </div>
            <div class="col-auto">
              <label for="typ_hriste" class="form-label">Typ hřiště</label>
              <select name="typ_hriste" id="typ_hriste" class="form-select">
                <option value="">-- Všechny --</option>
                {% for typ in hriste_typy %}
                  <option value="{{ typ }}" {% if typ == vybrany_typ %}selected{% endif %}>{{ typ }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-auto align-self-end">
              <button type="submit" class="btn btn-dark">Hledat</button>
            </div>
          </form>

          <div class="row">
            <div class="col-sm-12">
              <hr class="hr">
            </div>
          </div>
          <div class="row mt-4 mb-4">
            <div class="col-sm-12">
              <h3>Vyberte čas rezervace</h3>
              <div class="table-responsive">
                <table class="table table-bordered text-center" id="reservation-table">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Hřiště</th>
                      {% for hour in hours %}
                        <th scope="col">{{ hour.start }} - {{ hour.end }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for court in courts_data %}
                      <tr>
                        <th scope="row">{{ court.nazev }}</th>
                        {% for hour in hours %}
                          <td
                            class="reservation-slot {% if hour.start in court.reserved_hours %}reserved{% else %}free{% endif %}"
                            data-court="{{ court.id }}"
                            data-hour="{{ hour.start }}"
                            {% if hour.start in court.reserved_hours %}data-reserved="true"{% endif %}
                          >
                            {% if hour.start in court.reserved_hours %}
                              Obsazeno
                            {% else %}
                              Volné
                            {% endif %}
                          </td>
                        {% endfor %}
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="{{ hours|length|add:1 }}" class="text-center">
                          Žádná hřiště nenalezena.
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="text-center mt-3">
                  <button type="button" class="btn btn-primary" id="submit-reservations" disabled>Rezervovat vybrané časy</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // JavaScript pro rezervační systém
      const reservationSlots = document.querySelectorAll('.reservation-slot.free');
      const submitButton = document.getElementById('submit-reservations');
      let selectedSlots = [];
      
      // Přidání event listeneru na každý volný slot
      reservationSlots.forEach(slot => {
        slot.addEventListener('click', function() {
          if (this.classList.contains('reserved')) return; // Ignore reserved slots
          
          this.classList.toggle('selected');
          
          // Upravení seznamu vybraných slotů
          const courtId = this.getAttribute('data-court');
          const hour = this.getAttribute('data-hour');
          const slotKey = `${courtId}-${hour}`;
          
          if (this.classList.contains('selected')) {
            selectedSlots.push(slotKey);
          } else {
            selectedSlots = selectedSlots.filter(item => item !== slotKey);
          }
          
          // Aktualizace stavu tlačítka
          submitButton.disabled = selectedSlots.length === 0;
        });
      });
      
      // Event listener pro odeslání rezervace
      submitButton.addEventListener('click', function() {
        if (selectedSlots.length === 0) return;
        
        // Rozdělení vybraných slotů na pole objektů
        const reservations = selectedSlots.map(slot => {
          const [courtId, hour] = slot.split('-');
          return { court: courtId, hour: hour };
        });
        
        // Zavolání funkce pro zpracování více rezervací
        window.location.href = '/reserve_multiple/?slots=' + JSON.stringify(reservations);
      });
    });
  </script>
{% endblock %}